{% extends 'base.html' %}

{% block content %}
<div class="row g-3">
    <!-- Sidebar -->
    <div class="col-md-3 sidebar p-3 shadow-sm">
        <h6>ðŸ“Š Watchlist</h6>
        <ul id="savedList" class="list-group list-group-flush"></ul>

        <hr>
        <h6>Search Ticker</h6>
        <input id="tickerInput" class="form-control mb-2" placeholder="AAPL, MSFT, TCS.NS" value="AAPL">
        <button id="searchBtn" class="btn btn-primary w-100 mb-2">Fetch</button>
        <button id="saveFav" class="btn btn-outline-secondary w-100">Save</button>

        <div id="quickInfo" class="mt-3 small text-dark fw-semibold"></div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
        <!-- Price Chart -->
        <div class="card mb-3 shadow-sm">
            <div class="card-body">
                <canvas id="priceChart" height="300"></canvas>
            </div>
        </div>

        <!-- Indicators -->
        <div class="card mb-3 shadow-sm">
            <div class="card-body">
                <h6 class="text-primary fw-bold">Indicators</h6>
                <div id="indicators" class="small text-dark"></div>
            </div>
        </div>

        <!-- News -->
        <div class="card shadow-sm">
            <div class="card-body">
                <h6 class="fw-bold mb-2 text-primary">ðŸ“° Latest News</h6>
                <div id="newsList" class="small" style="max-height:300px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let priceChart = null;

async function fetchData(ticker){
    const res = await fetch(`/api/data?ticker=${ticker}`);
    return res.json();
}

async function fetchInfo(ticker){
    const res = await fetch(`/api/info?ticker=${ticker}`);
    return res.json();
}

async function fetchNews(ticker){
    const res = await fetch(`/api/search?q=${encodeURIComponent(ticker)}`);
    const data = await res.json();
    const newsDiv = document.getElementById("newsList");
    newsDiv.innerHTML = data.length ? data.map(n => `
        <div class="mb-2 border-bottom pb-2">
            <a href="${n.link || '#'}" target="_blank" class="fw-bold text-decoration-none text-primary">${n.symbol || n.title}</a>
            <p class="mb-1 text-secondary">${n.snippet || ''}</p>
        </div>
    `).join('') : '<p class="text-muted">No recent news found.</p>';
}

function renderChart(data){
    const ctx = document.getElementById('priceChart').getContext('2d');
    if(priceChart) priceChart.destroy();

    const datasets = [
        { label:'Close', data:data.closes, borderColor:'#6f42c1', backgroundColor:'rgba(111,66,193,0.2)', tension:0.3, pointRadius:0 },
        { label:'SMA50', data:data.sma50, borderColor:'#fd7e14', borderDash:[5,5], tension:0.2, pointRadius:0 },
        { label:'SMA200', data:data.sma200, borderColor:'#28a745', borderDash:[5,5], tension:0.2, pointRadius:0 }
    ];

    priceChart = new Chart(ctx, {
        type:'line',
        data:{ labels:data.timestamps, datasets:datasets },
        options:{
            responsive:true,
            interaction:{ mode:'index', intersect:false },
            stacked:false,
            plugins:{ legend:{ labels:{ color:'#000', boxWidth:12, font:{size:11} }, position:'bottom' } },
            scales:{
                x:{ ticks:{ color:'#000' }, grid:{ color:'#eee' } },
                y:{ ticks:{ color:'#000' }, grid:{ color:'#f0f0f0' } }
            }
        }
    });
}

function renderInfo(info){
    const el = document.getElementById('quickInfo');
    if(info.error){ el.innerHTML=`<span class="text-danger">${info.error}</span>`; return; }
    el.innerHTML = `
        <strong>${info.shortName || info.symbol}</strong><br>
        Sector: ${info.sector || 'N/A'} | Industry: ${info.industry || 'N/A'}<br>
        Market Cap: ${info.marketCap ? (Math.round(info.marketCap/1e9*100)/100)+'B' : 'N/A'}<br>
        Price: ${info.currentPrice || 'N/A'} | PE: ${info.trailingPE || 'N/A'}
    `;
}

// Search & Portfolio
document.getElementById('searchBtn').addEventListener('click', async ()=>{
    const ticker = document.getElementById('tickerInput').value.trim();
    if(!ticker) return alert('Enter ticker symbol');
    const data = await fetchData(ticker);
    if(data.error) return alert(data.error);
    renderChart(data);
    const info = await fetchInfo(ticker);
    renderInfo(info);
    fetchNews(ticker);
});

document.getElementById('saveFav').addEventListener('click', ()=>{
    const ticker = document.getElementById('tickerInput').value.trim();
    if(!ticker) return;
    fetch('/api/portfolio/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ticker})});
});

window.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('searchBtn').click();
});
</script>
{% endblock %}
